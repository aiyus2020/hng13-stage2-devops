name: üöÄ Deploy Blue-Green to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to EC2 Instance
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout the latest code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup SSH for EC2 connection
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_KEY }}" > ~/.ssh/terraform-deploy.pem
          chmod 600 ~/.ssh/terraform-deploy.pem
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      # 3Ô∏è‚É£ Connect to EC2 and deploy
      - name: Deploy using SSH
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          echo "===== üöÄ Starting Blue/Green Deployment ====="
          
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/terraform-deploy.pem $EC2_USER@$EC2_HOST << 'EOF'
            set -e
            echo "===== üîÑ Updating Packages ====="
            sudo apt update -y

            echo "===== üê≥ Installing Docker & Compose ====="
            sudo apt install -y docker.io docker-compose git
            sudo systemctl enable docker
            sudo systemctl start docker
            sudo chmod 666 /var/run/docker.sock || true

            echo "===== üì¶ Syncing Repository ====="
            if [ -d "~/hng13-stage2-devops/.git" ]; then
              echo "Repo already exists ‚Äî pulling latest changes..."
              cd ~/hng13-stage2-devops
              git reset --hard
              git pull origin main
            else
              echo "Repo not found ‚Äî cloning fresh copy..."
              git clone https://github.com/${{ github.repository }}.git ~/hng13-stage2-devops
              cd ~/hng13-stage2-devops
            fi

            echo "===== üîÅ Rebuilding Containers ====="
            sudo docker compose down || true
            sudo docker compose up -d

            echo "===== ‚úÖ Deployment Completed Successfully ====="
          EOF
